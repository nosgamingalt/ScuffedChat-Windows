<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ScuffedSnap</title>
    <link rel="icon" type="image/png" href="/static/faviconV2.png">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .admin-header {
            background: var(--bg-card);
            padding: 30px;
            border-radius: var(--radius-lg);
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
        }

        .admin-header h1 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .admin-header p {
            color: var(--text-muted);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .stat-card h3 {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .stat-card .stat-value {
            color: var(--accent-primary);
            font-size: 2.5rem;
            font-weight: 700;
        }

        .users-section {
            background: var(--bg-card);
            padding: 30px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .users-header {
            display: flex;
            justify-space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
        }

        .users-table thead {
            background: var(--bg-input);
        }

        .users-table th {
            padding: 15px;
            text-align: left;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .users-table td {
            padding: 15px;
            border-top: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }

        .user-row:hover {
            background: var(--bg-hover);
        }

        .admin-badge {
            background: var(--accent-primary);
            color: white;
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
            white-space: nowrap;
        }

        .btn-reset {
            background: var(--accent-primary);
            color: white;
        }

        .btn-reset:hover {
            opacity: 0.9;
        }

        .btn-delete {
            background: var(--accent-red);
            color: white;
        }

        .btn-delete:hover {
            background: #c92a2a;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .admin-container {
                padding: 20px 10px;
            }

            .users-table {
                font-size: 0.85rem;
                display: block;
                overflow-x: auto;
            }

            .users-table th,
            .users-table td {
                padding: 8px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .stat-card .stat-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>üõ°Ô∏è Admin Dashboard</h1>
            <p id="admin-info">Loading...</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="stat-value" id="total-users">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Messages</h3>
                <div class="stat-value" id="total-messages">0</div>
            </div>
            <div class="stat-card">
                <h3>Active Chats</h3>
                <div class="stat-value" id="active-chats">0</div>
            </div>
            <div class="stat-card">
                <h3>Friend Requests</h3>
                <div class="stat-value" id="pending-requests">0</div>
            </div>
        </div>

        <div class="users-section">
            <div class="users-header">
                <h2>User Management</h2>
                <input type="text" class="search-box" id="search-box" placeholder="Search by username or email...">
            </div>

            <div id="users-content">
                <div class="loading">Loading users...</div>
            </div>
        </div>
    </div>

    <script src="/static/js/supabase-config.js"></script>
    <script>
        let currentAdmin = null;
        let allUsers = [];

        // Wait for Supabase to initialize
        if (window.supabaseClient) {
            initAdmin();
        } else {
            window.addEventListener('supabase-ready', initAdmin);
        }

        async function initAdmin() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    window.location.href = '/';
                    return;
                }

                // Get user profile and check admin status
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();

                if (error || !profile || !profile.is_admin) {
                    alert('Access denied. Admin privileges required.');
                    window.location.href = '/app';
                    return;
                }

                currentAdmin = profile;
                document.getElementById('admin-info').textContent = `Logged in as: ${profile.username} (${session.user.email})`;

                // Load dashboard data
                await Promise.all([
                    loadStats(),
                    loadUsers()
                ]);

            } catch (error) {
                console.error('Admin init error:', error);
                alert('Error initializing admin panel: ' + error.message);
                window.location.href = '/';
            }
        }

        async function loadStats() {
            try {
                const [usersCount, messagesCount, requestsCount] = await Promise.all([
                    supabaseClient.from('profiles').select('*', { count: 'exact', head: true }),
                    supabaseClient.from('messages').select('*', { count: 'exact', head: true }),
                    supabaseClient.from('friends').select('*', { count: 'exact', head: true }).eq('status', 'pending')
                ]);

                document.getElementById('total-users').textContent = usersCount.count || 0;
                document.getElementById('total-messages').textContent = messagesCount.count || 0;
                document.getElementById('pending-requests').textContent = requestsCount.count || 0;

                // Calculate active chats
                const { data: messages } = await supabaseClient.from('messages').select('sender_id, receiver_id');
                if (messages) {
                    const uniquePairs = new Set(messages.map(m => [m.sender_id, m.receiver_id].sort().join('-')));
                    document.getElementById('active-chats').textContent = uniquePairs.size;
                }

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadUsers() {
            try {
                const { data: profiles, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Try to get emails using service role (admin.listUsers requires service role key)
                // Since we can't use admin functions from client, we'll use auth.users email from profile creation
                allUsers = profiles.map(profile => ({
                    ...profile,
                    email: 'See Supabase Dashboard' // Client can't access emails directly for security
                }));

                renderUsers(allUsers);

            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-content').innerHTML = `
                    <div class="empty-state">
                        <p>Failed to load users: ${error.message}</p>
                    </div>
                `;
            }
        }

        function renderUsers(users) {
            const content = document.getElementById('users-content');

            if (!users || users.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <p>No users found</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Registered</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr class="user-row">
                                <td>${escapeHtml(user.username)}</td>
                                <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                <td>${user.is_admin ? '<span class="admin-badge">ADMIN</span>' : 'User'}</td>
                                <td>
                                    <div class="action-buttons">
                                        ${user.id !== currentAdmin.id ? `
                                            <button class="btn-small btn-delete" onclick="deleteUser('${user.id}', '${escapeHtml(user.username)}')">
                                                Delete Account
                                            </button>
                                        ` : '<span style="color: var(--text-muted);">Current User</span>'}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p style="margin-top: 20px; color: var(--text-muted); font-size: 0.85rem;">
                    Note: To reset passwords or view emails, use the Supabase Dashboard ‚Üí Authentication ‚Üí Users
                </p>
            `;
        }

        async function deleteUser(userId, username) {
            if (!confirm(`Are you sure you want to delete user "${username}"?\n\nThis will permanently delete:\n‚Ä¢ Their profile\n‚Ä¢ All their messages\n‚Ä¢ All their friends\n‚Ä¢ All their data\n\nThis action cannot be undone.`)) {
                return;
            }

            const confirmAgain = prompt(`Type "${username}" to confirm deletion:`);
            if (confirmAgain !== username) {
                alert('Username did not match. Deletion cancelled.');
                return;
            }

            try {
                // Delete from profiles (will cascade to messages and friends)
                const { error } = await supabaseClient
                    .from('profiles')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                alert('User deleted successfully!');
                await Promise.all([loadStats(), loadUsers()]);

            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Failed to delete user: ' + error.message + '\n\nYou may need to delete from Supabase Dashboard ‚Üí Authentication ‚Üí Users');
            }
        }

        // Search functionality
        document.getElementById('search-box').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredUsers = allUsers.filter(user =>
                user.username.toLowerCase().includes(searchTerm)
            );
            renderUsers(filteredUsers);
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
